platform :ios, '12.0'

# Disable CocoaPods analytics.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

# -------- Figure out where the Flutter SDK is --------
def flutter_root
  # Generated.xcconfig is created by `flutter pub get`
  xcconfig_path = File.expand_path(File.join('Flutter', 'Generated.xcconfig'), __dir__)
  unless File.exist?(xcconfig_path)
    raise "#{xcconfig_path} missing. Run `flutter pub get` first."
  end

  File.foreach(xcconfig_path) do |line|
    m = line.match(/FLUTTER_ROOT=(.*)/)
    return m[1].strip if m
  end
  raise 'FLUTTER_ROOT not found in Generated.xcconfig'
end

require File.expand_path(
  File.join('packages', 'flutter_tools', 'bin', 'podhelper'),
  flutter_root
)

flutter_ios_podfile_setup        # <- installs all Flutter & plugin pods

# ------- Your app target -------
target 'Runner' do
  use_frameworks!
  use_modular_headers!

  flutter_additional_ios_build_settings(target)
end

# ------- Permissions block you added -------
post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)

    target.build_configurations.each do |config|
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= [
        '$(inherited)',
        'PERMISSION_CAMERA=1',
        'PERMISSION_PHOTOS=1',
        'PERMISSION_LOCATION=1',
        'PERMISSION_SENSORS=1',
        'PERMISSION_BLUETOOTH=1'
      ]
    end
  end
end
